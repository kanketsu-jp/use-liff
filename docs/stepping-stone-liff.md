# 踏み台LIFFの使い方

踏み台LIFFとは、ユーザーがLINEログインを行い、その結果としてLINE IDを取得するための中間的なLIFFアプリケーションです。このパターンを使用することで、他のLIFFアプリケーションやサービスがユーザーのLINE IDを安全かつ簡単に取得できるようになります。

## 概要

踏み台LIFFの主な目的は以下の通りです：

1. **LINEログインの実装** - ユーザーをLINEログイン画面に誘導
2. **トークンの取得** - ログイン成功後、IDトークンを取得
3. **サーバーへの送信** - トークンとクエリパラメータをサーバーに送信
4. **サーバー側での検証** - サーバー側でトークンを検証し、LINE IDを取得
5. **データベースへの保存** - LINE IDとクエリパラメータをデータベースに保存

## フロー図

```
ユーザー
  ↓
LIFFアプリにアクセス（クエリパラメータ付き）
  ↓
LINEログイン画面にリダイレクト
  ↓
ログイン成功
  ↓
LIFFアプリに戻る（クエリパラメータ保持）
  ↓
IDトークンを取得
  ↓
サーバーAPIに送信（トークン + クエリパラメータ）
  ↓
サーバー側でトークン検証
  ↓
LINE IDを取得
  ↓
データベースに保存（LINE ID + クエリパラメータ）
```

## 実装手順

### 1. クライアントサイドの実装

クライアントサイドでは、以下の処理を行います：

1. LIFFの初期化とログイン
2. IDトークンの取得
3. クエリパラメータの取得
4. サーバーAPIへの送信

詳細な実装例は [クライアントサイドの実装例](./examples/stepping-stone-client.tsx) を参照してください。

### 2. サーバーサイドの実装

サーバーサイドでは、以下の処理を行います：

1. IDトークンの受信
2. トークンの検証（LINE APIを使用）
3. LINE IDの取得
4. クエリパラメータの取得
5. データベースへの保存

詳細な実装例は [サーバーサイドのAPIエンドポイント例](./examples/stepping-stone-server.ts) を参照してください。

### 3. データベースへの保存

取得したLINE IDとクエリパラメータをデータベースに保存します。

対応可能なデータベース：
- Supabase
- Firestore
- PostgreSQL
- MySQL
- MongoDB
- その他のデータベース

詳細な実装例は [データベース保存の例](./examples/database-examples.ts) を参照してください。

## 重要なポイント

### クエリパラメータの引き継ぎ

LIFFアプリにクエリパラメータが付いている場合、ログイン後も引き継ぐ必要があります。そのため、`LiffProvider` の `loginConfig` プロパティで `redirectUri` を指定してください：

```tsx
<LiffProvider
  liffId={process.env.NEXT_PUBLIC_LIFF_ID!}
  loginConfig={{
    redirectUri: window.location.href, // クエリパラメータを含む現在のURL
  }}
>
  {children}
</LiffProvider>
```

### セキュリティ

- **IDトークンはサーバー側でのみ検証してください** - クライアント側で検証しても意味がありません
- **HTTPSを使用してください** - トークンの送信は必ずHTTPSで行ってください
- **トークンの有効期限を確認してください** - サーバー側でトークンの有効期限をチェックしてください

### エラーハンドリング

各ステップで適切なエラーハンドリングを行ってください：

- LIFFの初期化エラー
- ログインエラー
- トークン取得エラー
- サーバーAPI呼び出しエラー
- トークン検証エラー
- データベース保存エラー

## 次のステップ

- [サーバーサイドでの使用方法](./server-side-usage.md) を読んで、サーバー側の実装を理解する
- [サンプルコード](./examples/) を参考に、実際の実装を行う

